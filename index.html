<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ultimate Fitness Tracker - Phase 3</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; font-family: Arial, sans-serif; }
body { background-color:#f4f4f4; color:#333; transition: background-color 0.3s, color 0.3s; }
body.dark { background-color:#121212; color:#f4f4f4; }
header { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#6200ee; color:#fff; }
header h1 { font-size:1.5em; }
nav { display:flex; gap:15px; }
nav button { background:none; border:none; color:#fff; font-size:1em; cursor:pointer; padding:5px 10px; border-radius:5px; transition: background 0.2s; }
nav button:hover, nav button.active { background: rgba(255,255,255,0.2); }
.container { padding:20px; }
.tab { display:none; }
.tab.active { display:block; }
.workout-card, .history-card { background:#fff; padding:10px; margin:10px 0; border-radius:5px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.workout-card.dark, .history-card.dark { background:#1e1e1e; box-shadow:0 2px 5px rgba(0,0,0,0.4); }
.btn { padding:5px 10px; margin:2px; cursor:pointer; border:none; border-radius:5px; transition: background 0.2s; }
.btn.primary { background:#6200ee; color:#fff;}
.btn.danger { background:#e53935; color:#fff;}
.btn:hover { opacity:0.9; }
.modal { position:fixed; top:0; left:0; width:100%; height:100%; display:none; justify-content:center; align-items:center; background: rgba(0,0,0,0.5); }
.modal.active { display:flex; }
.modal-content { background:#fff; padding:20px; width:90%; max-width:700px; border-radius:10px; max-height:90%; overflow-y:auto; }
.modal-content.dark { background:#1e1e1e; color:#f4f4f4; }
.exercise-list, .selected-exercises { max-height:200px; overflow-y:auto; margin:10px 0; border:1px solid #ccc; border-radius:5px; padding:5px; }
.exercise-item { display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #eee; position:relative; }
.exercise-item:last-child { border-bottom:none; }
.exercise-item.dark { border-bottom:1px solid #444; }
input[type="number"], input[type="text"] { width:50px; padding:3px; margin-left:5px; border-radius:3px; border:1px solid #ccc; }
input[type="text"].search { width:100%; margin-bottom:10px; padding:5px; }
#librarySearch { margin-bottom:10px; width:100%; padding:5px; border-radius:5px; border:1px solid #ccc; }
.tooltip { position:absolute; background:#333; color:#fff; padding:3px 6px; border-radius:3px; font-size:0.8em; display:none; z-index:10;}
.tooltip.dark { background:#f4f4f4; color:#121212;}
canvas { max-width:100%; height:300px; }
body.dark input, body.dark select { background:#2c2c2c; color:#f4f4f4; border:1px solid #555;}
body.dark .exercise-list, body.dark .selected-exercises { background:#2c2c2c; border:1px solid #555;}
body.dark .exercise-item { border-bottom:1px solid #444;}
body.dark .modal-content { background:#1e1e1e; color:#f4f4f4; }
body.dark .btn.primary { background:#bb86fc; color:#121212;}
body.dark .btn.danger { background:#cf6679; color:#121212;}
.progress-bar { height:10px; border-radius:5px; background:#ccc; margin:3px 0; overflow:hidden; }
.progress-bar-inner { height:100%; width:0%; background:#6200ee; transition: width 0.3s; }
</style>
</head>
<body>

<header>
<h1>Ultimate Fitness Tracker</h1>
<nav>
<button class="tab-btn active" data-tab="workout">Workout</button>
<button class="tab-btn" data-tab="library">Library</button>
<button class="tab-btn" data-tab="history">History</button>
<button class="tab-btn" data-tab="dashboard">Dashboard</button>
<button class="tab-btn" data-tab="settings">Settings</button>
</nav>
</header>

<div class="container">
<div class="tab active" id="workout">
<button class="btn primary" id="createWorkoutBtn">Create A New Workout</button>
<h2>Saved Workouts</h2>
<div id="savedWorkouts"></div>
<h2>Templates</h2>
<div id="workoutTemplates"></div>
</div>

<div class="tab" id="library">
<input type="text" id="librarySearch" placeholder="Search exercises...">
<div id="exerciseLibraryList"></div>
</div>

<div class="tab" id="history">
<h2>Workout History</h2>
<div id="historyLog"></div>
</div>

<div class="tab" id="dashboard">
<h2>Progress Dashboard</h2>
<div>Workout Streak: <span id="workoutStreak">0</span> days</div>
<canvas id="volumeChart"></canvas>
<canvas id="prChart"></canvas>
<canvas id="avgRepsChart"></canvas>
</div>

<div class="tab" id="settings">
<h2>Settings / Profile</h2>
<label><input type="checkbox" id="darkModeToggle"> Dark Mode</label><br>
<label>Units: <select id="unitSelect"><option value="lbs">lbs</option><option value="kg">kg</option></select></label>
<h3>User Stats</h3>
<div id="userStats">
Bodyweight: <span id="userWeight">--</span><br>
Best Lift PRs: <span id="bestPRs">--</span><br>
Workout Streak: <span id="streakDisplay">0</span> days
</div>
</div>
</div>

<div class="modal" id="workoutModal">
<div class="modal-content">
<h2>Create Workout</h2>
<label>Workout Name: <input type="text" id="workoutName"></label>
<h3>Search Exercises</h3>
<input type="text" id="exerciseSearch" placeholder="Search exercises...">
<div class="exercise-list" id="exerciseList"></div>
<h3>Selected Exercises</h3>
<div class="selected-exercises" id="selectedExercises"></div>
<button class="btn primary" id="saveWorkout">Save Workout</button>
<button class="btn primary" id="saveTemplate">Save as Template</button>
<button class="btn danger" id="cancelWorkout">Cancel</button>
</div>
</div>

<script>
// ----------------------------- App State -----------------------------
const exerciseLibrary=[/* 500 exercises list here */];
let workouts=JSON.parse(localStorage.getItem('workouts'))||[];
let templates=JSON.parse(localStorage.getItem('templates'))||[];
let history=JSON.parse(localStorage.getItem('history'))||[];
let favorites=JSON.parse(localStorage.getItem('favorites'))||[];
let settings=JSON.parse(localStorage.getItem('settings'))||{darkMode:false,units:'lbs'};

// ----------------------------- Utilities -----------------------------
function saveState(){ 
  localStorage.setItem('workouts', JSON.stringify(workouts));
  localStorage.setItem('templates', JSON.stringify(templates));
  localStorage.setItem('history', JSON.stringify(history));
  localStorage.setItem('favorites', JSON.stringify(favorites));
  localStorage.setItem('settings', JSON.stringify(settings));
}
function renderTabs(){ 
  document.querySelectorAll('.tab-btn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab=btn.dataset.tab;
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.getElementById(tab).classList.add('active');
      renderWorkouts(); renderTemplates(); renderLibrary(); renderHistory(); renderDashboard(); updateSettingsUI();
    });
  });
}

// ----------------------------- Dark Mode & Units -----------------------------
const darkToggle=document.getElementById('darkModeToggle');
darkToggle.addEventListener('change',()=>{ settings.darkMode=darkToggle.checked; document.body.classList.toggle('dark',settings.darkMode); saveState(); });
document.body.classList.toggle('dark',settings.darkMode);
const unitSelect=document.getElementById('unitSelect');
unitSelect.value=settings.units;
unitSelect.addEventListener('change',()=>{ settings.units=unitSelect.value; saveState(); });
function updateSettingsUI(){ darkToggle.checked=settings.darkMode; document.body.classList.toggle('dark',settings.darkMode); unitSelect.value=settings.units; }

// ----------------------------- Workout Modal -----------------------------
const workoutModal=document.getElementById('workoutModal');
const createWorkoutBtn=document.getElementById('createWorkoutBtn');
const cancelWorkoutBtn=document.getElementById('cancelWorkout');
const saveWorkoutBtn=document.getElementById('saveWorkout');
const saveTemplateBtn=document.getElementById('saveTemplate');
const exerciseListDiv=document.getElementById('exerciseList');
const selectedExercisesDiv=document.getElementById('selectedExercises');
let selectedExercises=[];

createWorkoutBtn.addEventListener('click',()=>{ openWorkoutModal(); });
cancelWorkoutBtn.addEventListener('click',()=>{ workoutModal.classList.remove('active'); });

function openWorkoutModal(template=null){
    workoutModal.classList.add('active');
    document.getElementById('workoutName').value=template?template.name:'';
    selectedExercises=template?JSON.parse(JSON.stringify(template.exercises)):[];
    renderExerciseList();
    renderSelectedExercises();
}

// ----------------------------- Exercise List & AI Suggestions -----------------------------
function renderExerciseList(filter=''){
    exerciseListDiv.innerHTML='';
    const filtered=exerciseLibrary.filter(e=>e.toLowerCase().includes(filter.toLowerCase()));
    filtered.forEach(ex=>{
        const div=document.createElement('div');
        div.className='exercise-item'+(settings.darkMode?' dark':'');
        const tooltip=document.createElement('div'); tooltip.className='tooltip'+(settings.darkMode?' dark':''); tooltip.textContent='Recommended based on history and favorites';
        div.appendChild(tooltip);
        div.innerHTML+=`${ex} <button class="btn primary">Add ⭐</button>`;
        const btn=div.querySelector('button');
        btn.addEventListener('mouseenter',()=>{ tooltip.style.display='block'; tooltip.style.top='-20px'; tooltip.style.left='60%'; });
        btn.addEventListener('mouseleave',()=>{ tooltip.style.display='none'; });
        btn.addEventListener('click',()=>{
            if(!selectedExercises.find(x=>x.name===ex)){ 
                const suggestion=getAutoSuggestion(ex); 
                selectedExercises.push({name:ex, sets:[{reps:suggestion.reps, weight:suggestion.weight}]}); 
                renderSelectedExercises(); 
            }
        });
        exerciseListDiv.appendChild(div);
    });
}
document.getElementById('exerciseSearch').addEventListener('input',(e)=>{ renderExerciseList(e.target.value); });

// ----------------------------- Auto-Suggestions -----------------------------
function getAutoSuggestion(exercise){
    let past=[];
    history.forEach(w=>{ w.exercises.forEach(e=>{ if(e.name===exercise) past.push(...e.sets); }); });
    if(past.length===0) return {reps:8, weight:10};
    const last=past[past.length-1];
    return {reps:last.reps, weight:last.weight+2};
}

// ----------------------------- Selected Exercises -----------------------------
function renderSelectedExercises(){
    selectedExercisesDiv.innerHTML='';
    selectedExercises.forEach((ex,idx)=>{
        const div=document.createElement('div');
        div.className='exercise-item'+(settings.darkMode?' dark':'');
        div.innerHTML=`<strong>${ex.name}</strong>`;
        ex.sets.forEach((s,i)=>{
            const setDiv=document.createElement('div');
            setDiv.innerHTML=`Set ${i+1}: Reps <input type="number" min="0" value="${s.reps}"> Weight <input type="number" min="0" value="${s.weight}"> <button class="btn danger">Remove Set</button>`;
            setDiv.querySelectorAll('input')[0].addEventListener('input',e=>s.reps=+e.target.value);
            setDiv.querySelectorAll('input')[1].addEventListener('input',e=>s.weight=+e.target.value);
            setDiv.querySelector('button').addEventListener('click',()=>{ex.sets.splice(i,1); renderSelectedExercises();});
            div.appendChild(setDiv);
        });
        const addSetBtn=document.createElement('button');
        addSetBtn.className='btn primary'; addSetBtn.textContent='Add Set';
        addSetBtn.addEventListener('click',()=>{ 
            const suggestion=getAutoSuggestion(ex.name);
            ex.sets.push({reps:suggestion.reps, weight:suggestion.weight}); 
            renderSelectedExercises(); 
        });
        const removeExBtn=document.createElement('button'); removeExBtn.className='btn danger'; removeExBtn.textContent='Remove Exercise';
        removeExBtn.addEventListener('click',()=>{ selectedExercises.splice(idx,1); renderSelectedExercises(); });
        div.appendChild(addSetBtn); div.appendChild(removeExBtn);
        selectedExercisesDiv.appendChild(div);
    });
}

// ----------------------------- Save Workout / Template -----------------------------
saveWorkoutBtn.addEventListener('click',()=>{
    const name=document.getElementById('workoutName').value.trim();
    if(!name) return alert('Enter workout name');
    const w={name, exercises:selectedExercises, date:new Date().toISOString()};
    workouts.push(w); history.push(w);
    saveState(); workoutModal.classList.remove('active');
    renderWorkouts(); renderDashboard(); renderHistory(); renderTemplates(); renderUserStats();
});
saveTemplateBtn.addEventListener('click',()=>{
    const name=document.getElementById('workoutName').value.trim();
    if(!name) return alert('Enter template name');
    templates.push({name, exercises:selectedExercises});
    saveState(); renderTemplates();
});

// ----------------------------- Render Workouts & Templates -----------------------------
function renderWorkouts(){
    const container=document.getElementById('savedWorkouts'); container.innerHTML='';
    workouts.forEach((w,i)=>{
        const div=document.createElement('div'); div.className='workout-card'+(settings.darkMode?' dark':'');
        div.innerHTML=`<strong>${w.name}</strong> <button class="btn danger">Delete</button>`;
        div.querySelector('button').addEventListener('click',()=>{ workouts.splice(i,1); saveState(); renderWorkouts(); });
        container.appendChild(div);
    });
}
function renderTemplates(){
    const container=document.getElementById('workoutTemplates'); container.innerHTML='';
    templates.forEach((t,i)=>{
        const div=document.createElement('div'); div.className='workout-card'+(settings.darkMode?' dark':'');
        div.innerHTML=`<strong>${t.name}</strong> <button class="btn primary">Use Template</button>`;
        div.querySelector('button').addEventListener('click',()=>{ openWorkoutModal(t); });
        container.appendChild(div);
    });
}

// ----------------------------- Library -----------------------------
const librarySearch=document.getElementById('librarySearch');
const exerciseLibraryList=document.getElementById('exerciseLibraryList');
librarySearch.addEventListener('input',()=>{ renderLibrary(); });
function renderLibrary(){
    const filter = librarySearch.value.trim().toLowerCase();
    exerciseLibraryList.innerHTML='';
    const filtered = exerciseLibrary.filter(e=>e.toLowerCase().includes(filter));
    filtered.forEach(ex=>{
        const div=document.createElement('div'); div.className='exercise-item'+(settings.darkMode?' dark':'');
        div.innerHTML=`${ex} <button class="btn primary">⭐</button>`;
        const favBtn=div.querySelector('button'); favBtn.addEventListener('click',()=>{
            if(!favorites.includes(ex)) favorites.push(ex); else favorites=favorites.filter(f=>f!==ex);
            saveState(); renderLibrary();
        });
        exerciseLibraryList.appendChild(div);
    });
}

// ----------------------------- History -----------------------------
function renderHistory(){
    const container=document.getElementById('historyLog'); container.innerHTML='';
    history.forEach((w,i)=>{
        const div=document.createElement('div'); div.className='history-card'+(settings.darkMode?' dark':'');
        div.innerHTML=`${w.name} - ${new Date(w.date).toLocaleDateString()}`;
        container.appendChild(div);
    });
}

// ----------------------------- Dashboard -----------------------------
let volumeChart, prChart, avgRepsChart;
function renderDashboard(){
    const volumeCtx=document.getElementById('volumeChart').getContext('2d');
    const prCtx=document.getElementById('prChart').getContext('2d');
    const avgCtx=document.getElementById('avgRepsChart').getContext('2d');

    // Workout Streak
    const streakDisplay=document.getElementById('workoutStreak');
    let streak=calculateStreak(); streakDisplay.textContent=streak;

    // Total Volume
    const labels=history.map(w=>new Date(w.date).toLocaleDateString());
    const volumeData=history.map(w=>w.exercises.reduce((a,e)=>a+e.sets.reduce((b,s)=>b+s.reps*s.weight,0),0));

    // PRs
    const prMap={}; history.forEach(w=>{ w.exercises.forEach(e=>{ const maxWeight=Math.max(...e.sets.map(s=>s.weight)); if(!prMap[e.name]||prMap[e.name]<maxWeight) prMap[e.name]=maxWeight; }); });
    const prData=[]; for(const key in prMap) prData.push({exercise:key,value:prMap[key]});

    // Average Reps
    const avgRepsData=[]; for(const key in prMap){ let allReps=[]; history.forEach(w=>{ w.exercises.forEach(e=>{ if(e.name===key) allReps.push(...e.sets.map(s=>s.reps)); }); }); avgRepsData.push({exercise:key,value:(allReps.reduce((a,b)=>a+b,0)/allReps.length).toFixed(1)}); }

    if(volumeChart) volumeChart.destroy(); if(prChart) prChart.destroy(); if(avgRepsChart) avgRepsChart.destroy();
    volumeChart=new Chart(volumeCtx,{type:'line',data:{labels,datasets:[{label:'Total Volume',data:volumeData,borderColor:'blue',fill:false}]}});
    prChart=new Chart(prCtx,{type:'bar',data:{labels:prData.map(d=>d.exercise),datasets:[{label:'PR (Weight)',data:prData.map(d=>d.value),backgroundColor:'green'}]}});
    avgRepsChart=new Chart(avgCtx,{type:'bar',data:{labels:avgRepsData.map(d=>d.exercise),datasets:[{label:'Average Reps',data:avgRepsData.map(d=>d.value),backgroundColor:'orange'}]}});
}

// ----------------------------- User Stats -----------------------------
function renderUserStats(){
    document.getElementById('userWeight').textContent='--'; // placeholder
    document.getElementById('bestPRs').textContent=JSON.stringify(Object.fromEntries(Object.entries(getPRs())));
    document.getElementById('streakDisplay').textContent=calculateStreak();
}
function getPRs(){
    const prMap={}; history.forEach(w=>{ w.exercises.forEach(e=>{ const maxWeight=Math.max(...e.sets.map(s=>s.weight)); if(!prMap[e.name]||prMap[e.name]<maxWeight) prMap[e.name]=maxWeight; }); });
    return prMap;
}
function calculateStreak(){
    if(history.length===0) return 0;
    const dates=history.map(w=>new Date(w.date).setHours(0,0,0,0)).sort((a,b)=>b-a);
    let streak=1; let prev=dates[0];
    for(let i=1;i<dates.length;i++){
        if(prev-dates[i]===86400000){ streak++; prev=dates[i]; } else break;
    }
    return streak;
}

// ----------------------------- Initialize -----------------------------
renderTabs(); renderWorkouts(); renderTemplates(); renderLibrary(); renderHistory(); renderDashboard(); renderUserStats();
</script>
</body>
</html>
